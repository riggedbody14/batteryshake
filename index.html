<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Встряхни телефон</title>
    <!-- Подключение Tailwind CSS для стилизации -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* Используем шрифт Inter */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Стили для плавного перехода изображения */
        #image-placeholder {
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 flex items-center justify-center min-h-screen">

    <div id="app-container" class="text-center p-8 bg-white dark:bg-gray-800 rounded-2xl shadow-2xl max-w-sm w-full mx-4">
        <h1 id="instruction-text" class="text-2xl font-bold text-gray-800 dark:text-white mb-4">
            Встряхните телефон!
        </h1>
        <p id="status-text" class="text-sm text-gray-500 dark:text-gray-400 mb-6">
            Ожидание движения...
        </p>
        
        <!-- Контейнер для изображения, чтобы управлять размером -->
        <div class="w-full aspect-[3/4] bg-gray-200 dark:bg-gray-700 rounded-lg overflow-hidden flex items-center justify-center">
             <!-- Изображение-плейсхолдер -->
            <img id="image-placeholder" 
                 src="https://placehold.co/600x800/e2e8f0/4a5568?text=Потряси+меня" 
                 alt="Изображение-плейсхолдер"
                 class="w-full h-full object-cover">
        </div>

        <!-- Сообщение об ошибке, если датчики не доступны -->
        <p id="error-message" class="text-red-500 mt-4 font-medium hidden">
            Не удалось получить доступ к датчикам движения. Убедитесь, что вы используете HTTPS и предоставили разрешение.
        </p>
    </div>

    <script>
        // --- НАСТРОЙКИ ---
        // Чувствительность к встряхиванию. Меньше = более чувствительно.
        const SHAKE_THRESHOLD = 20; 
        // Время в миллисекундах, которое нужно подождать перед повторным обнаружением
        const COOLDOWN = 500; 

        // --- ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ ---
        let last_x, last_y, last_z;
        let last_update = 0;
        let shakeDetected = false;

        // --- ЭЛЕМЕНТЫ DOM ---
        const image = document.getElementById('image-placeholder');
        const instructionText = document.getElementById('instruction-text');
        const statusText = document.getElementById('status-text');
        const errorMessage = document.getElementById('error-message');

        // --- ЛОГИКА ПРИЛОЖЕНИЯ ---

        // Проверяем, поддерживается ли DeviceMotionEvent
        if (window.DeviceMotionEvent) {
            // Запрашиваем разрешение (необходимо для iOS 13+)
            if (typeof DeviceMotionEvent.requestPermission === 'function') {
                DeviceMotionEvent.requestPermission()
                    .then(permissionState => {
                        if (permissionState === 'granted') {
                            window.addEventListener('devicemotion', handleMotion);
                        } else {
                            showError("Разрешение на доступ к датчикам отклонено.");
                        }
                    })
                    .catch(error => showError(`Ошибка запроса разрешения: ${error.message}`));
            } else {
                // Для устройств, не требующих явного разрешения (например, Android)
                window.addEventListener('devicemotion', handleMotion);
            }
        } else {
            showError("Ваше устройство не поддерживает датчики движения.");
        }

        /**
         * Обрабатывает данные с акселерометра.
         * @param {DeviceMotionEvent} event - Событие движения устройства.
         */
        function handleMotion(event) {
            // Если встряхивание уже было обнаружено, ничего не делаем
            if (shakeDetected) return;

            const acceleration = event.accelerationIncludingGravity;
            const currentTime = new Date().getTime();

            // Обновляем не чаще, чем раз в 100 мс для производительности
            if ((currentTime - last_update) > 100) {
                const diffTime = currentTime - last_update;
                last_update = currentTime;

                const x = acceleration.x;
                const y = acceleration.y;
                const z = acceleration.z;

                // Если это первое обновление, просто сохраняем значения
                if (last_x === undefined && last_y === undefined && last_z === undefined) {
                    last_x = x;
                    last_y = y;
                    last_z = z;
                    return;
                }

                // Рассчитываем скорость изменения ускорения
                const speed = Math.abs(x + y + z - last_x - last_y - last_z) / diffTime * 10000;

                if (speed > SHAKE_THRESHOLD) {
                    onShake();
                }

                // Обновляем последние значения
                last_x = x;
                last_y = y;
                last_z = z;
            }
        }

        /**
         * Выполняется при обнаружении встряхивания.
         */
        function onShake() {
            shakeDetected = true; // Устанавливаем флаг, чтобы предотвратить повторные срабатывания
            
            // Визуальная обратная связь
            instructionText.textContent = "Получилось!";
            statusText.textContent = "Отличная работа! �";
            document.body.classList.add('bg-green-100', 'dark:bg-green-900');
            
            // Добавляем эффект "встряхивания" к картинке
            image.style.transform = 'scale(0.95)';
            image.style.opacity = '0.5';

            // Меняем изображение с небольшой задержкой
            setTimeout(() => {
                const newImageUrl = `https://placehold.co/600x800/34d399/ffffff?text=Ура!`;
                image.src = newImageUrl;
                image.alt = "Новое изображение после встряхивания";
                
                // Возвращаем картинку в нормальное состояние
                image.style.transform = 'scale(1)';
                image.style.opacity = '1';
            }, 200);

            // Удаляем слушатель события, чтобы он больше не срабатывал
            window.removeEventListener('devicemotion', handleMotion);
        }

        /**
         * Показывает сообщение об ошибке.
         * @param {string} message - Текст ошибки.
         */
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.remove('hidden');
            statusText.classList.add('hidden');
        }
    </script>

</body>
</html>